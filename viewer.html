<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PFL Top Stud Matches</title>
  <script>
    async function loadMatches() {
      const response = await fetch('top_stud_matches.json');
      const data = await response.json();
      const container = document.getElementById('content');
      window._matches = data;

      Object.entries(data).forEach(([mareId, { mare_name, mare_link, matches }]) => {
        const section = document.createElement('section');
        section.innerHTML = `
          <details open>
            <summary><strong>${mare_name}</strong> - <a href="${mare_link}" target="_blank">View Mare</a></summary>
            <table>
              <thead>
                <tr><th>Rank</th><th>Score</th><th>Reason</th><th>Stud Name</th><th>Link</th></tr>
              </thead>
              <tbody>
                ${matches.map(m => `
                  <tr>
                    <td>${m.rank}</td>
                    <td>${m.score}</td>
                    <td>${m.reason}</td>
                    <td>${m.stud_name}</td>
                    <td><a href="${m.stud_link}" target="_blank">View</a></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </details>
        `;
        container.appendChild(section);
      });
    }

    function exportToExcel() {
      const data = window._matches;
      let csv = 'Mare Name,Mare Link,Rank,Score,Reason,Stud Name,Stud Link\n';

      for (const [_, { mare_name, mare_link, matches }] of Object.entries(data)) {
        for (const m of matches) {
          csv += `"${mare_name}","${mare_link}",${m.rank},${m.score},"${m.reason}","${m.stud_name}","${m.stud_link}"\n`;
        }
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'top_stud_matches.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.onload = loadMatches;
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #fafafa; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
    details summary { font-size: 1.2rem; margin-top: 1rem; cursor: pointer; }
    #export-btn { margin-bottom: 1rem; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Top Stud Matches per Mare</h1>
  <button id="export-btn" onclick="exportToExcel()">⬇️ Export to Excel (CSV)</button>
  <div id="content">Loading...</div>
</body>
</html>
